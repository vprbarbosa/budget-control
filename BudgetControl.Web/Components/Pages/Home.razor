@page "/"
@rendermode InteractiveServer
@inject BudgetControl.Web.Services.BudgetApiClient Api

<h2>Controle de despesas</h2>

<button @onclick="OpenNewCycleModal">
    + Novo acompanhamento
</button>

<!-- LISTAGEM DOS ACOMPANHAMENTOS -->
@if (_cycles.Any())
{
    @foreach (var cycle in _cycles)
    {
        <details @ontoggle="() => Toggle(cycle.Id)">
            <summary>@cycle.FundingSourceName</summary>

            @if (_expandedCycleId == cycle.Id)
            {
                <CycleDetails CycleId="@cycle.Id" />
            }
        </details>
    }

}
else
{
    <p>Nenhum acompanhamento cadastrado.</p>
}

<!-- MODAL NOVO ACOMPANHAMENTO -->
@if (_showNewCycleModal)
{
    <div style="position:fixed; inset:0; background:rgba(0,0,0,0.4);
                display:flex; align-items:center; justify-content:center;">
        <div style="background:white; padding:20px; width:400px; border-radius:6px;">

            <h3>Novo acompanhamento</h3>

            <label>Fonte financeira</label>
            <select value="@_selectedFundingSourceValue"
                    @onchange="OnFundingSourceChanged"
                    style="width:100%; margin-bottom:10px;">
                <option value="">Selecione</option>
                @foreach (var fs in _fundingSources)
                {
                    <option value="@fs.Id">@fs.Name</option>
                }
                <option value="NEW">+ Novo</option>
            </select>

            <label>Total disponível</label>
            <input type="number"
                   step="0.01"
                   @bind="_newCycleTotal"
                   style="width:100%; margin-bottom:10px;" />

            <label>Duração (dias)</label>
            <input type="number"
                   @bind="_newCycleDays"
                   style="width:100%; margin-bottom:10px;" />

            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button @onclick="CloseNewCycleModal">Cancelar</button>
                <button @onclick="CreateCycle">Salvar</button>
            </div>
        </div>
    </div>
}

<!-- MODAL NOVA FONTE FINANCEIRA -->
@if (_showNewFundingModal)
{
    <div style="position:fixed; inset:0; background:rgba(0,0,0,0.4);
                display:flex; align-items:center; justify-content:center;">
        <div style="background:white; padding:20px; width:400px; border-radius:6px;">

            <h3>Nova fonte financeira</h3>

            <input placeholder="Descrição"
                   @bind="_newFundingDescription"
                   style="width:100%; margin-bottom:10px;" />

            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button @onclick="CloseFundingModal">Cancelar</button>
                <button @onclick="SaveNewFunding">Salvar</button>
            </div>
        </div>
    </div>
}

@code {
    private Guid? _expandedCycleId;
    private IReadOnlyCollection<BudgetCycleListItemDto> _cycles = Array.Empty<BudgetCycleListItemDto>();

    private bool _showNewCycleModal;
    private bool _showNewFundingModal;

    private string _selectedFundingSourceValue = "";
    private FundingSourceVm? _selectedFundingSource;

    private decimal _newCycleTotal;
    private int _newCycleDays = 30;

    private List<FundingSourceVm> _fundingSources = new();

    private string _newFundingDescription = "";
    
    private void Toggle(Guid cycleId)
    {
        _expandedCycleId =
            _expandedCycleId == cycleId ? null : cycleId;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadFundingSources();
        await LoadCycles();
    }

    private async Task LoadFundingSources()
    {
        _fundingSources = (await Api.GetAllFundingSources()).ToList();
    }

    private async Task LoadCycles()
    {
        _cycles = await Api.GetAllCycles();
    }

    private void OpenNewCycleModal()
        => _showNewCycleModal = true;

    private void CloseNewCycleModal()
    {
        _showNewCycleModal = false;
        _selectedFundingSource = null;
        _selectedFundingSourceValue = "";
        _newCycleTotal = 0;
        _newCycleDays = 30;
    }

    private void OnFundingSourceChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString() ?? "";
        _selectedFundingSourceValue = value;

        if (value == "NEW")
        {
            _showNewFundingModal = true;
            return;
        }

        if (Guid.TryParse(value, out var id))
            _selectedFundingSource = _fundingSources.First(x => x.Id == id);
    }

    private async Task SaveNewFunding()
    {
        if (string.IsNullOrWhiteSpace(_newFundingDescription))
            return;

        var id = await Api.CreateFundingSource(_newFundingDescription);

        await LoadFundingSources();

        _selectedFundingSource =
            _fundingSources.First(x => x.Id == id);

        _selectedFundingSourceValue = id.ToString();

        _newFundingDescription = "";
        _showNewFundingModal = false;
    }

    private void CloseFundingModal()
    {
        _showNewFundingModal = false;
        _newFundingDescription = "";
        _selectedFundingSourceValue = "";
    }

    private async Task CreateCycle()
    {
        if (_selectedFundingSource is null)
            return;

        var request = new CreateBudgetCycleRequest
        {
            FundingSourceId = _selectedFundingSource.Id,
            StartDate = DateOnly.FromDateTime(DateTime.Today),
            EstimatedDurationInDays = _newCycleDays,
            TotalCapacity = _newCycleTotal
        };

        await Api.CreateBudgetCycle(request);
        CloseNewCycleModal();
        await LoadCycles();
    }
}
