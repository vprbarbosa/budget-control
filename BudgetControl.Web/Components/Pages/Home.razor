@page "/"
@rendermode InteractiveServer
@inject BudgetControl.Web.Services.BudgetApiClient Api

<div class="page-container">

    <h2 class="page-title">Controle de despesas</h2>

    <div style="display:flex; gap:12px; margin-bottom:16px;">
        <button class="btn btn-primary"
                @onclick="OpenNewCycleModal">
            + Novo ciclo
        </button>

        <button class="btn btn-primary"
                @onclick="OpenGlobalExpenseModal">
            + Nova despesa
        </button>

        <button class="btn btn-primary"
                @onclick="OpenCloseDayBatchModal">
            Finalizar despesas do dia
        </button>
    </div>

    @if (_cycles.Any())
    {
        <div class="cycle-list">
            @foreach (var cycle in _cycles)
            {
                <details class="cycle-item"
                         @ontoggle="() => Toggle(cycle.Id)">
                    <summary class="cycle-summary">
                        @cycle.Title
                    </summary>

                    @if (_expandedCycleId == cycle.Id)
                    {
                        <CycleDetails CycleId="@cycle.Id" OnToastRequested="ShowToast" />
                    }
                </details>
            }
        </div>
    }
    else
    {
        <p>Nenhum acompanhamento cadastrado.</p>
    }
</div>

@if (_showNewCycleModal)
{
    <div class="budget-modal-backdrop">
        <div class="budget-modal">

            <h3>Novo acompanhamento</h3>

            <div class="form-group">
                <label>Data inicial</label>
                <input type="date"
                       value="@_newCycleStartDate.ToString("yyyy-MM-dd")"
                       @onchange="OnStartDateChanged" />
            </div>

            <div class="form-group">
                <label>Fonte financeira</label>
                <select value="@_selectedFundingSourceValue"
                        @onchange="OnFundingSourceChanged">
                    <option value="">Selecione</option>
                    @foreach (var fs in _fundingSources)
                    {
                        <option value="@fs.Id">@fs.Name</option>
                    }
                    <option value="NEW">+ Novo</option>
                </select>
            </div>

            <div class="form-group">
                <label>Total disponível</label>
                <input type="number"
                       step="0.01"
                       @bind="_newCycleTotal" />
            </div>

            <div class="form-group">
                <label>Duração (dias)</label>
                <input type="number"
                       @bind="_newCycleDays" />
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" @onclick="CloseNewCycleModal">
                    Cancelar
                </button>
                <button class="btn btn-primary" @onclick="CreateCycle">
                    Salvar
                </button>
            </div>
        </div>
    </div>
}

@if (_showGlobalExpenseModal)
{
    <div class="budget-modal-backdrop">
        <div class="budget-modal">

            <h3>Nova despesa</h3>

            <div class="form-group">
                <label>Ciclo</label>
                <select @onchange="OnExpenseCycleChanged">
                    <option value="">Selecione</option>
                    @foreach (var cycle in _cycles)
                    {
                        <option value="@cycle.Id">
                            @cycle.FundingSourceName
                        </option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label>Valor</label>
                <input type="number"
                       step="0.01"
                       @bind="_expenseAmount" />
            </div>

            <div class="form-group">
                <label>Descrição</label>
                <input @bind="_expenseDescription" />
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary"
                        @onclick="CloseGlobalExpenseModal">
                    Cancelar
                </button>

                <button class="btn btn-primary"
                        @onclick="SaveGlobalExpense"
                        disabled="@(!_selectedExpenseCycleId.HasValue)">
                    Salvar
                </button>
            </div>
        </div>
    </div>
}


@if (_showNewFundingModal)
{
    <div class="budget-modal-backdrop">
        <div class="budget-modal">

            <h3>Nova fonte financeira</h3>

            <div class="form-group">
                <label>Descrição</label>
                <input @bind="_newFundingDescription" />
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" @onclick="CloseFundingModal">
                    Cancelar
                </button>
                <button class="btn btn-primary" @onclick="SaveNewFunding">
                    Salvar
                </button>
            </div>
        </div>
    </div>
}

@if (_showCloseDayBatchModal)
{
    <div class="budget-modal-backdrop">
        <div class="budget-modal">

            <h3>Finalizar despesas do dia</h3>

            <p>Selecione os acompanhamentos:</p>

            <div class="cycle-select-list">
                @foreach (var c in _selectableCycles)
                {
                    <label class="cycle-select-item">
                        <input type="checkbox" @bind="c.Selected" />
                        <span>@c.Name</span>
                    </label>
                }
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary"
                        @onclick="CloseCloseDayBatchModal">
                    Cancelar
                </button>

                <button class="btn btn-primary"
                        disabled="@(!_selectableCycles.Any(x => x.Selected))"
                        @onclick="OpenCloseDayBatchConfirm">
                    Continuar
                </button>
            </div>
        </div>
    </div>
}

@if (_showCloseDayBatchConfirm)
{
    <div class="budget-modal-backdrop">
        <div class="budget-modal">

            <h3>Confirmação</h3>

            <p>
                Confirma a finalização das despesas do dia,
                para os itens selecionados?
            </p>

            <div class="modal-actions">
                <button class="btn btn-secondary"
                        @onclick="CancelCloseDayBatchConfirm">
                    Cancelar
                </button>

                <button class="btn btn-primary"
                        @onclick="ConfirmCloseDayBatch">
                    Confirmar
                </button>
            </div>
        </div>
    </div>
}

@if (_showToast)
{
    <div class="toast">
        @_toastMessage
    </div>
}


@code {
    private bool _showToast;
    private string _toastMessage = "";

    private Guid? _expandedCycleId;
    private IReadOnlyCollection<BudgetCycleListItemDto> _cycles = Array.Empty<BudgetCycleListItemDto>();
    private DateOnly _newCycleStartDate = DateOnly.FromDateTime(DateTime.Today);

    private bool _showNewCycleModal;
    private bool _showNewFundingModal;
    private bool _showGlobalExpenseModal;

    private Guid? _selectedExpenseCycleId;
    private DateOnly _expenseReferenceDate;

    private decimal _expenseAmount;
    private string _expenseDescription = "";

    private string _selectedFundingSourceValue = "";
    private FundingSourceVm? _selectedFundingSource;

    private decimal _newCycleTotal;
    private int _newCycleDays = 30;

    private List<FundingSourceVm> _fundingSources = new();
    private string _newFundingDescription = "";

    private bool _showCloseDayBatchModal;
    private bool _showCloseDayBatchConfirm;

    private List<SelectableCycle> _selectableCycles = new();

    private sealed class SelectableCycle
    {
        public Guid CycleId { get; init; }
        public string Name { get; init; } = "";
        public bool Selected { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadFundingSources();
        await LoadCycles();
    }

    private async Task LoadFundingSources()
        => _fundingSources = (await Api.GetAllFundingSources()).ToList();

    private async Task LoadCycles()
        => _cycles = await Api.GetAllCycles();

    private void Toggle(Guid id)
        => _expandedCycleId = _expandedCycleId == id ? null : id;

    private void OpenNewCycleModal()
        => _showNewCycleModal = true;

    private void CloseNewCycleModal()
    {
        _showNewCycleModal = false;
        _selectedFundingSource = null;
        _selectedFundingSourceValue = "";
        _newCycleTotal = 0;
        _newCycleDays = 30;
        _newCycleStartDate = DateOnly.FromDateTime(DateTime.Today);
    }

    private void OnFundingSourceChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString() ?? "";
        _selectedFundingSourceValue = value;

        if (value == "NEW")
        {
            _showNewFundingModal = true;
            return;
        }

        if (Guid.TryParse(value, out var id))
            _selectedFundingSource = _fundingSources.First(x => x.Id == id);
    }

    private async Task SaveNewFunding()
    {
        if (string.IsNullOrWhiteSpace(_newFundingDescription))
            return;

        var id = await Api.CreateFundingSource(_newFundingDescription);
        await LoadFundingSources();

        _selectedFundingSource = _fundingSources.First(x => x.Id == id);
        _selectedFundingSourceValue = id.ToString();

        _newFundingDescription = "";
        _showNewFundingModal = false;
    }

    private void CloseFundingModal()
    {
        _showNewFundingModal = false;
        _newFundingDescription = "";
        _selectedFundingSourceValue = "";
    }

    private async Task CreateCycle()
    {
        if (_selectedFundingSource is null)
            return;

        await Api.CreateBudgetCycle(new CreateBudgetCycleRequest
        {
            FundingSourceId = _selectedFundingSource.Id,
            StartDate = _newCycleStartDate,
            EstimatedDurationInDays = _newCycleDays,
            TotalCapacity = _newCycleTotal
        });

        CloseNewCycleModal();
        await LoadCycles();

        ShowToast("Acompanhamento criado com sucesso");
    }

    private void OnStartDateChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();

        if (DateOnly.TryParse(value, out var date))
            _newCycleStartDate = date;
    }

    private void OpenGlobalExpenseModal()
    {
        _selectedExpenseCycleId = null;
        _expenseAmount = 0;
        _expenseDescription = "";
        _showGlobalExpenseModal = true;
    }

    private async Task OnExpenseCycleChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();

        if (!Guid.TryParse(value, out var cycleId))
            return;

        _selectedExpenseCycleId = cycleId;

        var days = await Api.GetDays(cycleId);

        var openDay = days
            .Where(d => !d.IsClosed)
            .OrderBy(d => d.Date)
            .FirstOrDefault();

        if (openDay is not null)
            _expenseReferenceDate = openDay.Date;
    }

    private async Task SaveGlobalExpense()
    {
        if (!_selectedExpenseCycleId.HasValue || _expenseAmount <= 0)
            return;

        await Api.RegisterExpense(new RegisterPartialExpenseInput
        {
            BudgetCycleId = _selectedExpenseCycleId.Value,
            Amount = _expenseAmount,
            Description = _expenseDescription
        });

        _showGlobalExpenseModal = false;

        await LoadCycles();

        ShowToast("Despesa registrada com sucesso");
    }

    private void CloseGlobalExpenseModal()
    {
        _showGlobalExpenseModal = false;
    }

    private void OpenCloseDayBatchModal()
    {
        _selectableCycles = _cycles
            .Select(c => new SelectableCycle
            {
                CycleId = c.Id,
                Name = c.FundingSourceName,
                Selected = true
            })
            .ToList();

        _showCloseDayBatchModal = true;
    }

    private void OpenCloseDayBatchConfirm()
    {
        _showCloseDayBatchModal = false;
        _showCloseDayBatchConfirm = true;
    }

    private void CancelCloseDayBatchConfirm()
    {
        _showCloseDayBatchConfirm = false;
        _showCloseDayBatchModal = true;
    }

    private void CloseCloseDayBatchModal()
    {
        _showCloseDayBatchModal = false;
    }

    private async Task ConfirmCloseDayBatch()
    {
        var selectedCycleIds = _selectableCycles
            .Where(c => c.Selected)
            .Select(c => c.CycleId)
            .ToList();

        foreach (var cycleId in selectedCycleIds)
        {
            await Api.CloseCurrentDay(cycleId);
        }

        _showCloseDayBatchConfirm = false;

        await LoadCycles();

        ShowToast("Despesas do dia finalizadas");
    }

    private void ShowToast(string message)
    {
        _toastMessage = message;
        _showToast = true;

        StateHasChanged();

        _ = HideToastLater();
    }

    private async Task HideToastLater()
    {
        await Task.Delay(2500);

        _showToast = false;
        await InvokeAsync(StateHasChanged);
    }

}
