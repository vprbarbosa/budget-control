@page "/"
@rendermode InteractiveServer
@inject BudgetControl.Web.Services.BudgetApiClient Api

@if (_summary is null)
{
    <p>Carregando...</p>
}
else
{
    <h3>@_summary.FundingSourceName</h3>

    <div style="font-size: 1.5rem;">
        <p><strong>Meta diária:</strong> @_summary.DailyCapacity</p>
        <p><strong>Total restante:</strong> @_summary.RemainingCapacity</p>
        <p><strong>Dias restantes:</strong> @_summary.RemainingDays</p>
    </div>

    <table style="width:100%; margin-top:20px; border-collapse: collapse;">
        <thead>
            <tr>
                <th style="text-align:left;">Data</th>
                <th style="text-align:left;">Dia</th>
                <th style="text-align:right;">Gasto</th>
                <th style="text-align:center;">Fechado</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var day in _days)
            {
                <tr style="cursor:pointer" @onclick="async () => await OpenDay(day.Date)">
                    <td>@day.Date.ToString("dd/MM")</td>
                    <td>@day.Date.DayOfWeek</td>
                    <td style="text-align:right;">
                        @day.TotalSpent.ToString("C")
                    </td>
                    <td style="text-align:center;">
                        @(day.IsClosed ? "✔" : "")
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @if (_showDayModal)
    {
        <div style="
            position:fixed;
            top:0;
            left:0;
            right:0;
            bottom:0;
            background:rgba(0,0,0,0.4);">

            <div style="
                background:white;
                width:420px;
                margin:80px auto;
                padding:20px;
                border-radius:6px;">

                <h3>@_selectedDate.ToString("dd/MM/yyyy")</h3>

                <hr />

                <!-- Lista de gastos -->
                @if (_expenses.Any())
                {
                    <ul>
                        @foreach (var e in _expenses)
                        {
                            <li>
                                <strong>@e.Amount.ToString("C")</strong>
                                — @e.Description
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p>Nenhum gasto neste dia.</p>
                }

                <hr />

                <!-- Formulário de novo gasto -->
                <h4>Novo gasto</h4>

                <div style="display:flex; flex-direction:column; gap:8px;">
                    
                    <input type="number" @bind="_newExpenseAmount" />
                    <input type="text" @bind="_newExpenseDescription" />

                    <button @onclick="AddExpense">
                        Adicionar
                    </button>
                </div>

                <hr />

                <div style="display:flex; justify-content:space-between;">
                    <button @onclick="CloseModal">Fechar</button>
                    
                    <button style="background:#eee;" @onclick="CloseDay">
                        Fechar dia
                    </button>
                </div>
            </div>
        </div>
        
    }


}

@code {
    private DailyBudgetSummaryDto? _summary;
    private decimal _newExpenseAmount;
    private string _newExpenseDescription = string.Empty;
    private bool _showDayModal;
    private DateOnly _selectedDate;
    
    private IReadOnlyCollection<DayExpenseDto> _expenses = Array.Empty<DayExpenseDto>();
    private IReadOnlyCollection<BudgetCycleDayDto> _days = Array.Empty<BudgetCycleDayDto>();

    protected override async Task OnInitializedAsync()
    {
        var cycleId = Guid.Parse("7c098c29-cde1-4723-98e7-a240eae69641");

        _summary = await Api.GetDailySummary(cycleId);
        _days = await Api.GetDays(cycleId);
    }

    private async Task OpenDay(DateOnly date)
    {
        _selectedDate = date;
        _expenses = await Api.GetExpenses(_summary.BudgetCycleId, date);
        _showDayModal = true;
    }


    private void CloseModal()
    {
        _showDayModal = false;
        _expenses = Array.Empty<DayExpenseDto>();
    }

    private void AddExpenseLocal()
    {
        if (_newExpenseAmount <= 0)
            return;

        _expenses = _expenses.Append(new DayExpenseDto
        {
            Id = Guid.NewGuid(),
            Amount = _newExpenseAmount,
            Description = _newExpenseDescription
        }).ToList();

        _newExpenseAmount = 0;
        _newExpenseDescription = string.Empty;
    }

    private async Task AddExpense()
    {
        if (_newExpenseAmount <= 0)
            return;

        await Api.RegisterExpense(new RegisterPartialExpenseInput
        {
            BudgetCycleId = _summary!.BudgetCycleId,
            Amount = _newExpenseAmount,
            Description = _newExpenseDescription
        });

        // Recarrega tudo
        _expenses = await Api.GetExpenses(_summary.BudgetCycleId, _selectedDate);
        _summary = await Api.GetDailySummary(_summary.BudgetCycleId);
        _days = await Api.GetDays(_summary.BudgetCycleId);

        _newExpenseAmount = 0;
        _newExpenseDescription = string.Empty;
    }

    private async Task CloseDay()
    {
        await Api.CloseCurrentDay(_summary.BudgetCycleId);

        // Recarrega tudo
        _summary = await Api.GetDailySummary(_summary.BudgetCycleId);
        _days = await Api.GetDays(_summary.BudgetCycleId);

        // Atualiza o dia selecionado:
        // se ainda existir um dia aberto, mostra o próximo
        var nextOpenDay = _days.FirstOrDefault(d => !d.IsClosed);

        if (nextOpenDay is not null)
        {
            _selectedDate = nextOpenDay.Date;
            _expenses = await Api.GetExpenses(_summary.BudgetCycleId, _selectedDate);
        }
        else
        {
            // ciclo encerrado
            _showDayModal = false;
            _expenses = Array.Empty<DayExpenseDto>();
        }
    }
}
